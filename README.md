# redis-coupon-example

올리브영 - Redis Pub/Sub을 활용한 쿠폰 발급 비동기 처리

https://oliveyoung.tech/2023-08-07/async-process-of-coupon-issuance-using-redis/

## 📌 목표

1. 수만명이 몰리는 트래픽에도 쿠폰 다운로드 시간을 최소화한다.(5s 미만)
2. Redis를 사용하여 성능을 챙기면서도, 작업이 유실되지 않도록 안전하게 정합성을 보장한다.
3. Redis를 도입했을 때의 성능이 유의미하게 관측되어야 한다 - TPS 최소 1.5배 이상 또는 지연시간 30% 이상 개선

## ✨ 기능

- Redis가 없는 쿠폰 발급 API
- Redis가 있는 쿠폰 발급 API

## 👀 고려사항

### 수량 등 쿠폰 발급 유효성 검사는 어떻게 할 것인가?(동시성)

`@Lock`을 사용하여 트랜잭션 동안 다른 쓰레드가 읽지도, 쓰지도 못하게 설정

### 쿠폰 발급 워커는 어떻게 구상할 것인가?

워커 하나 당 토픽 하나를 할당하여 라운드 로빈으로 워커에게 작업 전달
<br>
쓰레드풀을 할당하여 비동기로 작업하도록 설계

### pub/sub을 어떻게 활용할 것인가?

Redis pub/sub은 브로드캐스트 구조이므로 서로 다른 토픽에 워커를 할당
<br>
특정 워커에게 작업이 있다는 것을 알리는데 활용한다

### list를 어떻게 활용할 것인가?

쿠폰 발급에 필요한 데이터(ex. 유저 아이디, 쿠폰 아이디)를 리스트에 넣고 워커가 꺼내쓰도록 하는 저장소 역할
<br>
Redis가 단일 스레드로서 명령을 순차적으로 처리하기 때문에 `LPUSH`와 `RPOP`은 원자적이다

## ⚙️ 테스트 환경

사용도구 : JMeter

설정

> 독립적으로 할당 가능한 포트가 약 65,000개이므로 요청 수를 60,000으로 제한

- Nubmer of Threads(users) : 2000
- Ramp-up period : 1
- Loop Count: 300

주의사항

- HTTP 요청을 보내면서 캐싱을 수행하지 않도록 해야한다
- `CSV Data Set Config`를 활용하여 각 요청마다 다른 userId를 부여한다
- `Same user on each iteration`을 해제하여 중복된 userId가 생기지 않도록 한다

## ✔️ 테스트 결과(TPS)

개선 전 일반 발급 API : 921

Redis를 이용한 발급 API : 2110

---

**일반 발급 API**
![basic](/.github/image/basic.png)

**Redis 동기 발급 API**
![basic](/.github/image/redis_sync.png)

**Redis 비동기 발급 API**
![basic](/.github/image/redis_async.png)

---

## 📜 결과

**수만명이 몰려도 5s 미만으로 요청 처리**
<br>
→ 가장 느린 응답시간은 0.5s로 만족(실제 쿠폰 발급 시간이 아닌 요청 처리 시간임)

**정합성 보장**
<br>
→ 다중 워커를 두면서도 비관적 락을 사용하여 정합성을 보장함

**1.5배 성능 개선**
<br>
→ TPS 921 에서 2110으로 2배 넘게 상승, 그러나 실제 쿠폰 발급 시간은 DB I/O 개선이 이루어져야 함

## 👍 느낀점

Redis의 도입은 쿠폰 발급 처리 시간을 줄이는 것이 목적이 아니므로 비동기로 처리하여 **사용자의 대기시간을 줄이는데** 의의가 있다

Redis를 도입함으로써 비동기로 요청된 쿠폰 발급이 실패했을 때, 발급 성공으로 안내받은 사용자에게는 어떻게 처리해줘야 하는지 고민이 필요하다

테스트 결과에서 알 수 있듯, Redis는 속도가 빠르지만 결국 외부 I/O 작업이므로 사용하는 순간 처리에 대한 추가 시간이 발생한다
<br>
이를 고려하지 않고 무작정 도입하는 것은 애플리케이션의 성능을 오히려 떨어뜨리는 행위가 될 수 있다